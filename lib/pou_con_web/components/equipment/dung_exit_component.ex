defmodule PouConWeb.Components.Equipment.DungExitComponent do
  use PouConWeb, :live_component
  alias PouCon.Equipment.Controllers.DungExit

  @impl true
  def update(assigns, socket) do
    equipment = assigns[:equipment]
    status = equipment.status || %{error: :invalid_data}
    display_data = calculate_display_data(status)

    {:ok,
     socket
     |> assign(:status, status)
     |> assign(:device_name, assigns.id)
     |> assign(:display, display_data)}
  end

  @impl true
  def render(assigns) do
    ~H"""
    <div class={"bg-white shadow-sm rounded-xl border border-gray-200 overflow-hidden w-40 transition-colors duration-300 " <> if(@display.is_error, do: "border-red-300 ring-1 ring-red-100", else: "")}>
      <!-- HEADER -->
      <div class="flex items-center justify-between px-2 py-2 bg-gray-50 border-b border-gray-100">
        <div class="flex items-center gap-1.5 overflow-hidden flex-1 min-w-0">
          <div class={"h-1.5 w-1.5 flex-shrink-0 rounded-full bg-#{@display.color}-500 animate-pulse" <> if(@display.is_running, do: "", else: "")}>
          </div>
          <span class="font-bold text-gray-700 text-xs truncate">{@status.title}</span>
        </div>
        
    <!-- Static Manual Badge (No toggles) -->
        <div class="flex-shrink-0 ml-1">
          <span class="px-2 py-0.5 rounded text-[9px] font-bold uppercase bg-gray-100 text-gray-400 border border-gray-200">
            Manual Only
          </span>
        </div>
      </div>
      
    <!-- BODY -->
      <div class="flex items-center gap-2 p-2">
        <!-- Visualization (Agitator/Spinner) -->
        <div class={[@display.anim_class, "text-#{@display.color}-500"]}>
          <svg width="48" height="42" viewBox="-5.0 -10.0 110.0 135.0" fill="currentColor">
            <path d="m94.445 81.48h-0.53516c-0.92578-0.66406-3.4219-2.6953-5.2852-6.2148 0.066406 0.007813 0.12891 0.035156 0.19531 0.035156 0.41797 0 0.82813-0.14062 1.1641-0.41406l3.4805-2.8203c0.64453-0.52344 0.86328-1.4102 0.53516-2.1719l-1.8125-4.207c-0.22656-0.52734-0.6875-0.92188-1.2461-1.0625l-3.5234-0.89844c-0.92188-0.24219-1.8672 0.26563-2.1953 1.1523l-1.1289 3.0664c-0.55469-0.96484-0.99609-1.8984-1.168-2.7617-0.39844-2-3.0352-2.5-3.9023-2.6641-1.1992-0.22656-2.8477-0.36719-3.832-0.17188-0.14453 0.03125-0.30078 0.085938-0.45703 0.13281l-0.27344-2.6797c-0.078126-0.78125-0.64453-1.4258-1.4062-1.6094l-7.0625-1.7188c-0.48047-0.11719-0.98438-0.035156-1.4023 0.21875-0.42188 0.25781-0.71875 0.66797-0.83594 1.1484l-0.67969 2.832c-0.070313 0.30859-0.066407 0.62891 0.019531 0.92969l1.4297 5.1094c0.15234 0.54297 0.54297 0.98828 1.0625 1.207l3.6914 1.5586c0.23438 0.10156 0.48047 0.14453 0.71875 0.14453 0.71875 0 1.4062-0.42578 1.707-1.1328 1.2656-0.97266 3.3086-2.332 4.2148-2.5117 0.60938-0.11328 2.6602 0.11719 3.5 0.46094 0.57812 2.1992 1.9883 4.2812 3.3555 6.3008 0.85547 1.2695 1.668 2.4688 2.2305 3.6172 1.0312 2.1133 2.2734 3.8047 3.4414 5.1133h-24.574c1.5703-1.5234 3.1523-3.6797 4.9141-7.2031 0.45703-0.91406 0.085938-2.0273-0.82812-2.4844-0.91406-0.45703-2.0273-0.085938-2.4844 0.82812-1.7695 3.5391-3.2148 5.4062-4.7305 6.6953v-2.6523c0-1.0234-0.82813-1.8516-1.8516-1.8516h-0.37109v-27.035c0-1.0234-0.82812-1.8516-1.8516-1.8516-1.0234 0-1.8516 0.82813-1.8516 1.8516v27.035h-2.9648v-30.434l14.801-3.6953c0.054687-0.015625 0.097656-0.050781 0.14844-0.070313 2.7773-0.41406 5.1055-2.1562 6.3281-4.5742l0.03125 0.03125c0.35938 0.34766 0.82031 0.51953 1.2852 0.51953 0.48438 0 0.96875-0.19141 1.332-0.56641 0.71094-0.73438 0.6875-1.9102-0.046875-2.6172l-1.4531-1.4023c-0.070313-0.070313-0.16016-0.097657-0.24219-0.15234-0.20312-4.5195-3.9102-8.1445-8.4805-8.1445-0.60547 0-1.1914 0.070313-1.7617 0.1875h-0.035157l-2.3047 0.57422c0.003906-0.36328-0.0625-0.73047-0.28125-1.0547l-1.8594-2.7734c-0.28125-0.42188-0.72656-0.71094-1.2305-0.79297l-2.4062-0.40625-1.8008-3.6016c-0.26562-0.53516-0.77344-0.90234-1.3594-1-0.59766-0.09375-1.1836 0.097656-1.6055 0.51953l-4.4453 4.4453c-0.23828 0.23828-0.40625 0.53516-0.48828 0.85938l-1.1094 4.4453c-0.085938 0.33984-0.070313 0.69922 0.039062 1.0352l0.75781 2.2734-2.918 0.72656c-0.10938-0.21094-0.26172-0.40625-0.45703-0.56641l-2.8906-2.3945-0.95703-3.3516c-0.14062-0.48828-0.46875-0.89453-0.91797-1.1289-0.44922-0.23438-0.96484-0.27734-1.4492-0.11719l-6.668 2.2227c-0.55078 0.18359-0.98438 0.61719-1.1719 1.1719l-1.1133 3.332c-0.11328 0.33594-0.125 0.69531-0.039063 1.0352l0.875 3.4961-4.6797 1.168-4.1992-4.1992c-0.34766-0.34766-0.81641-0.54297-1.3086-0.54297h-4.0391c-0.33203 0-0.66016 0.089844-0.94531 0.26172l-3.7383 2.2227c-0.63281 0.375-0.98438 1.0898-0.89062 1.8203l0.53516 4.2578c-2.9375 1.3477-4.9922 4.2969-4.9922 7.7344 0 4.0586 2.8594 7.4531 6.668 8.3008v20.957h-0.36719c-1.0234 0-1.8516 0.82812-1.8516 1.8516v4.8164h-2.5938c-1.0234 0-1.8516 0.82812-1.8516 1.8516 0 1.0234 0.82812 1.8516 1.8516 1.8516h88.891c1.0234 0 1.8516-0.82812 1.8516-1.8516 0-1.0234-0.82812-1.8516-1.8516-1.8516zm-27.656-20.406 0.13281-0.55859 3.9883 0.96875 0.28516 2.8203c-0.72656 0.48047-1.3477 0.9375-1.7305 1.2344l-1.6172-0.68359-1.0586-3.7852zm21.332 6.6562 1.0234 0.26172 0.89453 2.082-1.5703 1.2695-1.4766-0.55078zm-38.492 10.785h7.4062v2.9648h-7.4062zm-31.809-39.332 39.781-9.9375c-0.34766 0.92969-0.56641 1.9258-0.56641 2.9727 0 2.5234 1.125 4.7695 2.8711 6.3281l-39.715 9.918c0.33594-0.91406 0.54688-1.8867 0.54688-2.918 0-2.5469-1.1445-4.8086-2.9219-6.3711zm15.867 9.7344-2.4609 5.7383-7.9609-3.1367 10.418-2.6016zm-12.945 5.5859 6.2891 2.4805-6.2891 1.5703zm16.895-5.3945 7.6055 3.3242-10.109 2.5273zm10.516 0.55469-6.3477-2.7734 6.3477-1.5859zm22.223-17.445c0 2.6562-2.1602 4.8164-4.8164 4.8164s-4.8164-2.1602-4.8164-4.8164c0-2.6523 2.1602-4.8164 4.8164-4.8164s4.8164 2.1602 4.8164 4.8164zm-21.777-6.7422 0.85547-3.4258 2.2656-2.2656 1.0742 2.1445c0.26562 0.53125 0.76562 0.89844 1.3516 1l2.5469 0.42969 1.3203 1.9648-8.7305 2.1797-0.67578-2.0312zm-17.781 3.4805 0.64844-1.9453 3.9531-1.3164 0.58203 2.043c0.10547 0.35938 0.3125 0.67969 0.60156 0.91797l1.8672 1.5469-6.9062 1.7227-0.74219-2.9727zm-16.57 4h2.7617l2.0859 2.0859-6.8008 1.6992-0.30469-2.4414zm-6.8398 12.594c0-2.6562 2.1602-4.8164 4.8164-4.8164s4.8164 2.1602 4.8164 4.8164c0 2.6523-2.1602 4.8164-4.8164 4.8164s-4.8164-2.1602-4.8164-4.8164zm6.668 8.3008c0.33984-0.074218 0.66406-0.19141 0.98828-0.30859 0.050781-0.007813 0.10547-0.003907 0.15625-0.019531l1.8203-0.45313v16.922c0 1.0234 0.82813 1.8516 1.8516 1.8516s1.8516-0.82812 1.8516-1.8516v-7.6289l27.406-6.8477v19.289h-0.37109c-1.0234 0-1.8516 0.82812-1.8516 1.8516v4.8164h-22.961v-4.8164c0-1.0234-0.82812-1.8516-1.8516-1.8516h-7.0391v-20.957zm-2.2188 24.66h7.4062v2.9648h-7.4062zm0.36719-30.66c-1.0234 0-1.8516-0.82812-1.8516-1.8516v-0.90234c0-1.0234 0.82812-1.8516 1.8516-1.8516 1.0234 0 1.8516 0.82812 1.8516 1.8516v0.90234c0 1.0234-0.82812 1.8516-1.8516 1.8516zm53.336-17.941c1.0234 0 1.8516 0.82812 1.8516 1.8516v0.90234c0 1.0234-0.82812 1.8516-1.8516 1.8516-1.0234 0-1.8516-0.82812-1.8516-1.8516v-0.90234c0-1.0234 0.82812-1.8516 1.8516-1.8516zm-41.797 12.5c-0.25-0.99219 0.35547-2 1.3477-2.2461l26.668-6.6602c0.98828-0.25 1.9961 0.35547 2.2461 1.3477 0.25 0.99219-0.35547 2-1.3477 2.2461l-26.668 6.6602c-0.14844 0.039063-0.30078 0.054688-0.44922 0.054688-0.82812 0-1.582-0.5625-1.793-1.4023zm50.777 35.262c-0.85547-0.5625-1.0898-1.7109-0.52734-2.5664l1.1133-1.6875c0.5625-0.85156 1.7109-1.0898 2.5664-0.52734 0.85547 0.5625 1.0898 1.7109 0.52734 2.5664l-1.1133 1.6875c-0.35547 0.53906-0.94531 0.83203-1.5469 0.83203-0.34766 0-0.70312-0.097656-1.0195-0.30469zm6.6953-22.215c-0.5625-0.85547-0.32422-2.0039 0.52734-2.5664 0.85547-0.5625 2.0039-0.32422 2.5664 0.53125l1.1094 1.6875c0.5625 0.85547 0.32422 2.0039-0.52734 2.5664-0.3125 0.20703-0.66797 0.30469-1.0156 0.30469-0.60156 0-1.1953-0.29297-1.5469-0.83203l-1.1094-1.6875zm-14.973-9.0781c0.99219 0.25 1.5898 1.2578 1.3398 2.25l-0.5 1.957c-0.21094 0.83984-0.96484 1.3945-1.793 1.3945-0.15234 0-0.30469-0.019531-0.45703-0.058594-0.99219-0.25-1.5898-1.2578-1.3398-2.25l0.5-1.957c0.25-0.99219 1.2695-1.5898 2.25-1.3398zm16.461-1.1914-2.2227-3.8906c-0.41016-0.71875-1.2539-1.0781-2.0547-0.87891l-4.4414 1.1094c-0.55859 0.14062-1.0195 0.53125-1.25 1.0547l-1.4531 3.332c-0.37891 0.87109-0.039062 1.8867 0.78516 2.3555l5.8984 3.332c0.28516 0.16406 0.60156 0.23828 0.91016 0.23828 0.64453 0 1.2695-0.33594 1.6094-0.93359l2.2227-3.8906c0.32422-0.57031 0.32422-1.2695 0-1.8359zm-4.5234 2.2891-2.8398-1.6055 0.42188-0.96875 2.1992-0.55078 1 1.75-0.78516 1.3711z" />
          </svg>
        </div>
        
    <!-- Controls -->
        <div class="flex-1 flex flex-col gap-1 min-w-0">
          <div class={"text-[9px] font-bold uppercase tracking-wide text-#{@display.color}-500 truncate"}>
            <%= if @display.is_error do %>
              {@display.err_msg}
            <% else %>
              {@display.state_text}
            <% end %>
          </div>

          <%= if !@display.is_offline do %>
            <button
              phx-click="toggle_power"
              phx-target={@myself}
              class={[
                "w-full py-2 px-1 rounded font-bold text-[9px] shadow-sm transition-all text-white flex items-center justify-center gap-1 active:scale-95",
                (@display.is_running or @display.is_error) && "bg-red-500 hover:bg-red-600",
                (!@display.is_running and !@display.is_error) && "bg-emerald-500 hover:bg-emerald-600"
              ]}
            >
              <.icon name="hero-power" class="w-3 h-3" />
              <%= cond do %>
                <% @display.is_error -> %>
                  RESET
                <% @display.is_running -> %>
                  STOP
                <% true -> %>
                  START
              <% end %>
            </button>
          <% else %>
            <div class="w-full py-2 px-1 rounded font-bold text-[9px] text-center text-gray-400 bg-gray-100 border border-gray-200 cursor-not-allowed uppercase">
              Offline
            </div>
          <% end %>
        </div>
      </div>
    </div>
    """
  end

  # ——————————————————————————————————————————————
  # Event Handlers
  # ——————————————————————————————————————————————

  # No "set_mode" handler needed as this is strictly manual

  @impl true
  def handle_event("toggle_power", _, socket) do
    # Logic simplified: Always assume we can toggle unless offline
    name = socket.assigns.device_name

    if socket.assigns.display.is_running or socket.assigns.display.is_error do
      DungExit.turn_off(name)
    else
      DungExit.turn_on(name)
    end

    {:noreply, socket}
  end

  # ——————————————————————————————————————————————
  # Logic Helpers
  # ——————————————————————————————————————————————

  defp calculate_display_data(%{error: :invalid_data}) do
    %{
      is_offline: true,
      is_error: false,
      is_running: false,
      state_text: "OFFLINE",
      color: "gray",
      anim_class: ""
    }
  end

  defp calculate_display_data(status) do
    is_running = status.is_running
    has_error = not is_nil(status.error)

    {color, anim_class} =
      cond do
        has_error -> {"rose", ""}
        # Use Amber for Dung/Agitator when running (Earth tone), or stick to Green if preferred
        is_running -> {"green", "animate-bounce"}
        true -> {"violet", ""}
      end

    %{
      is_offline: false,
      is_error: has_error,
      is_running: is_running,
      # Always Manual
      state_text: if(is_running, do: "RUNNING", else: "STOPPED"),
      color: color,
      anim_class: anim_class,
      err_msg: status.error_message
    }
  end
end
